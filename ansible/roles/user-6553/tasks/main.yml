- name: Create cloudadmins group
  group:
    name: cloudadmins
    state: present

- name: Create users
  user:
    name: "{{ item }}"
    groups: cloudadmins,wheel
    append: yes
    generate_ssh_key: "{{ item == 'user100' and inventory_hostname == 'vm1' }}"
    ssh_key_type: rsa
    ssh_key_file: .ssh/id_rsa
  loop: "{{ users }}"

- name: Fetch user100 private key
  fetch:
    src: /home/user100/.ssh/id_rsa
    dest: "{{ playbook_dir }}/../backup_ssh_keys/id_rsa_user100"
    flat: yes
  when: inventory_hostname == "vm1"

- name: Ensure authorized_keys for user100
  authorized_key:
    user: user100
    key: "{{ lookup('file', playbook_dir + '/../backup_ssh_keys/id_rsa.pub') }}"
    state: present
  when: inventory_hostname == "vm1"
